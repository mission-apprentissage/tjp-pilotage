services:
  app:
    image: pilotage_app
    container_name: pilotage_app
    restart: "always"
    ports:
      - "127.0.0.1:5000:5000"
      - "127.0.0.1:3000:3000"
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_ENV=production
        - NEXT_PUBLIC_BASE_URL=https://{{ dns_name }}
        - NEXT_PUBLIC_SERVER_URL=https://{{ dns_name }}/api
        - NEXT_PUBLIC_APP_CONTAINER_URL=http://app:5000/api
        - NEXT_PUBLIC_CRISP_TOKEN={{ vault[env_type].NEXT_PUBLIC_CRISP_TOKEN }}
        - NEXT_PUBLIC_SENTRY_DSN={{ vault[env_type].SENTRY_DSN }}
        - NEXT_PUBLIC_SENTRY_AUTH_TOKEN={{ vault[env_type].SENTRY_AUTH_TOKEN }}
        - NEXT_PUBLIC_SENTRY_RELEASE={{ host_name }}_{{ git_revision }}
        - PILOTAGE_GIT_REVISION={{ git_revision }}
    networks:
      - pilotage_network
    environment:
      - PSQL_URI={{ vault[env_type].PSQL_URI }}
      - PSQL_CA={{ vault[env_type].PSQL_CA }}
      - ENV=production
      - LOG_LEVEL=info
      - HOST={{ host_name }}
      - LOG_DESTINATIONS=stdout,mongodb,slack
      - PUBLIC_URL=https://{{ dns_name }}
      - SLACK_WEBHOOK_URL={{ vault[env_type].SLACK_WEBHOOK_URL }}
      - SLACK_TOKEN={{ vault[env_type].SLACK_TOKEN }}
      - SLACK_SIGNING_SECRET={{ vault[env_type].SLACK_SIGNING_SECRET }}
      - SLACK_CHANEL={{ vault[env_type].SLACK_CHANEL }}
      - API_KEY={{ vault[env_type].API_KEY }}
      - AUTH_PASSWORD_HASH_ROUNDS={{ vault[env_type].AUTH_PASSWORD_HASH_ROUNDS }}
      - INSERJEUNES_USERNAME={{ vault[env_type].INSERJEUNES_USERNAME }}
      - INSERJEUNES_PASSWORD={{ vault[env_type].INSERJEUNES_PASSWORD }}
      - AUTH_JWT_SECRET={{ vault[env_type].AUTH_JWT_SECRET }}
      - ACTIVATION_JWT_SECRET={{ vault[env_type].ACTIVATION_JWT_SECRET }}
      - RESET_PASSWORD_JWT_SECRET={{ vault[env_type].RESET_PASSWORD_JWT_SECRET }}
      - EMAIL_FROM={{ vault[env_type].EMAIL_FROM }}
      - EMAIL={{ vault[env_type].EMAIL }}
      - SMTP_HOST={{ vault[env_type].SMTP_HOST }}
      - SMTP_PORT={{ vault[env_type].SMTP_PORT }}
      - SMTP_SECURE={{ vault[env_type].SMTP_SECURE }}
      - SMTP_AUTH_USER={{ vault[env_type].SMTP_AUTH_USER }}
      - SMTP_AUTH_PASS={{ vault[env_type].SMTP_AUTH_PASS }}
      - DNE_CODE_VERIFIER_JWT_SECRET={{ vault[env_type].DNE_CODE_VERIFIER_JWT_SECRET }}
      - DNE_CLIENT_ID={{ vault[env_type].DNE_CLIENT_ID }}
      - DNE_CLIENT_SECRET={{ vault[env_type].DNE_CLIENT_SECRET }}
      - DNE_REDIRECT_URI=https://{{ dns_name }}/api/dne_connect
      - S3_REGION={{ vault[env_type].S3_REGION }}
      - S3_BUCKET={{ vault[env_type].S3_BUCKET }}
      - S3_ENDPOINT={{ vault[env_type].S3_ENDPOINT }}
      - S3_ACCESS_KEY={{ vault[env_type].S3_ACCESS_KEY }}
      - S3_SECRET_KEY={{ vault[env_type].S3_SECRET_KEY }}
      - NOTION_TOKEN={{ vault[env_type].NOTION_TOKEN }}
      - NOTION_DB_CHANGELOG_ID={{ vault[env_type].NOTION_DB_CHANGELOG_ID }}
      - NOTION_DB_GLOSSAIRE_ID={{ vault[env_type].NOTION_DB_GLOSSAIRE_ID }}
      - NOTION_DB_EDITO_ID={{ vault[env_type].NOTION_DB_EDITO_ID }}
      - SENTRY_AUTH_TOKEN={{ vault[env_type].SENTRY_AUTH_TOKEN }}
      - SENTRY_DSN={{ vault[env_type].SENTRY_DSN }}
      - METABASE_AUTH_TOKEN={{ vault[env_type].METABASE_AUTH_TOKEN }}
      - FRANCE_TRAVAIL_CLIENT={{ vault[env_type].FRANCE_TRAVAIL_CLIENT }}
      - FRANCE_TRAVAIL_SECRET={{ vault[env_type].FRANCE_TRAVAIL_SECRET }}

  metabase:
    environment:
      - MB_SITE_URL=https://orion.inserjeunes.beta.gouv.fr/metabase
      - MB_DB_CONNECTION_URI={{ vault[env_type].METABASE_DB_URI }}
      - MB_DB_TYPE=postgres
